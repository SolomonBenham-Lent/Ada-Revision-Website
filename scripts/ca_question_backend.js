const ca_data = [
    {
        section: "1. Problem Solving & Algorithms",
        items: [
            {num: "CA 1.1: Problem Solving", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1PRzhHcDddqY7bGDn6IJE_0VdIJXVKduy/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1loTTJ5egha0f4tSSloQKkl8grbSs9RcL/view?usp=classroom_web&authuser=0"},
            {num: "CA 1.2: Algorithms", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/13DsXV4_8uGMAdKEHvP3ZbhkcTuCroonv/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/13AaArOF1-0xBvXrglHOX7XWpZ129jX8a/view?usp=classroom_web&authuser=0"}
        ]
    },
    {
        section: "2. Introduction to Programming",
        items: [
            {num: "CA 2.1: Program Data", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1uAienHdVjt3Qw2qN6okpcTzD8IpdWmFu/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/146gYfT50lQalhes_wpHdvqrXDJC4YOxB/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.2: Operators", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1cNfIA5McL2tmhZvz-dcFoUqaPJmuodjp/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1uK8eK6Q5khNllQjUXm4cg7oc2rLfsVPl/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.3: File handling", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1SX9LiEVIPDH32B2zgEcXiR-L3_mnYiFN/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1swo-UyhYDNbZyk_5zK5y5YizuiePFao2/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.4: Program Structure", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1E9SpVHcZ8Jvb8XTtM5O1xzEHRgFfsVbR/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1RsQ-8mvk_nG4Bt8wTDjnrspofBqVCz6S/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.5: Built-in Functions", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1xT6tDd7AmnTP3L57v4SPUl-jSYHvR0Vd/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: ""},
            {num: "CA 2.6: Validation and Error Handling", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1m0j0A9k3zmfAPjt2LyY9Q6eD_Mu4kZ6e/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1qUjClJaoEY2X8ucjNtTnFA357XTFc3y3/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.7: Maintainable Code", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1DTqNJvW1x6LWNw1-KTTiyZ570sOU7V3D/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1hOUZBWoLt-1krFe__0E5elSnw6CrzhLX/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.8: Testing", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1R9e1xnIYF9MaNmbtLNpVvpXPT7Yc1TnQ/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/11t3YPYSL4j_Au51oipproLBVpGhYDjRW/view?usp=classroom_web&authuser=0"}
        ]
    },
    {
        section: "3. Emerging Issues",
        items: [
            {num: "CA 3.1: Moral and Ethical Issues", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1uSZK39PywoEAGrKG7-0oefX8UckmzwIY/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1RRpmX467PdLyCcDUzySx1MK8i4vmhTjS/view?usp=classroom_web&authuser=0"},
            {num: "CA 3.2: Emerging Trends and Technologies", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1JiXLR3CRtmC6p2YijxoNes1wzfbaEI4t/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: ""}
        ]
    },
    {
        section: "4. Legislation & Regulatory Requirements",
        items: [
            {num: "CA 4.1: Legislation", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1XQjVC57FPE7exwX6tNCV-xcOZaF0UJSc/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: ""},
            {num: "CA 4.2: Guidelines and codes of conduct", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1NBzVaX8IW5Jyt06kexj82JcHPPyNrNyJ/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: ""}
        ]
    },
    {
        section: "5. Business Context",
        items: [
            {num: "CA 5.1: Business Environment", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1UWQdXIm0p16MihgWYSpulWVqeDRpBo2V/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1SwRQj1Q9BzlScOc-gKhyt2GDre3O1OVb/view?usp=classroom_web&authuser=0"},
            {num: "CA 5.2: Digital Value To Business", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1oKJe2Nl1yrLPoIj1-miAKwAzG9ta0xEG/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1ZuI3GHb8-Lauzx50ElvOojLpI6XdULPH/view?usp=classroom_web&authuser=0"},
            {num: "CA 5.3: Technical Change Management", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1nYvUcNxx3P-gIrqbYMYENPvrhPPgXE0m/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1M4iI1uEfGdAu-zadyzuuWICvce-aT8n2/view?usp=classroom_web&authuser=0"},
            {num: "CA 5.4: Risks in a Business Context", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1pS9WAYuTyPFyLt1PFfC1SJnH-vVtlD3j/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1IHDiYtSQ127F8yV1kNjhxfNlBMdBc-tZ/view?usp=classroom_web&authuser=0"}
        ]
    },
    {
        section: "6. Data",
        items: [
            {num: "CA 6.1: Data and information in organisations", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1xHltOC5mRNGbYhCml3CpNyCphJzvOvL-/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1ULxlLVnnAZDZfOEC6cBnfSFPJ9kT2uG-/view?usp=classroom_web&authuser=0"},
            {num: "CA 6.2: Data formats", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1nB7ug88YaKB6fCBqE3ObANcleoK8r-8C/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/19XNAmUwvaBB7Spbq3fU6R4KOPmFV8KCh/view?usp=classroom_web&authuser=0"},
            {num: "CA 6.3: Data Systems", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1C2M70HAquXBy8HzN9u4uI2H2ecJzu-n9/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1VBzxVJ3FB4Hxs4yQcvqHSjmPqodKFxi4/view?usp=classroom_web&authuser=0"},
            {num: "CA 6.4: Data Management", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1cfBAzWMZqJdr9YbxYpj1HXWXGI5BPZmB/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1N90iLsUc-WdTKCmexeiLphM50h8X6puW/view?usp=classroom_web&authuser=0"}
        ]
    },
    {
        section: "7. Digital Environments",
        items: [
            {num: "CA 7.1: Physical Environments", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1ebCiZL8Ao8_c5QBjQok2CB_AinpG6eMs/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/15zlwuPgMh_0hEzeMnDCXnqEIHt02Nujz/view?usp=classroom_web&authuser=0"},
            {num: "CA 7.2: Networks", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/19a3D0rBACKFqqCPh0G7aV91X0LRSppO4/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1Cmkcd8FswnrVlSHpd6BhljLfZykVP3Be/view?usp=classroom_web&authuser=0"},
            {num: "CA 7.3: Virtual Environments", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1D9mMEKwf6eMQyH9CqilNc8ofESHO2PLw/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1iO8djqb2rFUI9VZSH-IRhj1CCB4ek-LG/view?usp=classroom_web&authuser=0"},
            {num: "CA 7.4: Cloud Environments", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1a64pZHuRKHY0iG8YaoI9LMDOoN75Bf4S/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1pIFbXFZtT1ARTSbBo852NasUtPvLVndK/view?usp=classroom_web&authuser=0"},
            {num: "CA 7.5: Resilience of Environment", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1pUpplMSgP6eVPcCNnmgRnTclMQpu69IW/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/18ai7nNPzP3_bCqBNzv05Lh3gRSPm3xrH/view?usp=classroom_web&authuser=0"}
        ]
    },
    {
        section: "8. Security",
        items: [
            {num: "CA 8.1: Security Risks", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1Nr4m7sfyt1_zgztdxoArEmPElibosJr7/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1cg3Nv6lkWXBU8933mbBI8HWr77sMGBQm/view?usp=classroom_web&authuser=0"},
            {num: "CA 8.2: Threat mitigation", question_name: "Practice Question", question_url: "https://drive.google.com/file/d/1BmRJY9pfhkN0wi3TOzAv_ry7gXL0NSO7/view?usp=classroom_web&authuser=0", answer_name: "Mark Scheme", answer_url: "https://drive.google.com/file/d/1dYrlAYkc2T9DRzyElJE-GSp588-lD4d1/view?usp=classroom_web&authuser=0"}
        ]
    }
];

function generateCaList() {
    const ca_list = [];
    ca_data.forEach((section, index) => {
        ca_list.push({num: `Content Area ${index + 1}`, question_name: "", question_url: "", answer_name: "", answer_url: ""});
        section.items.forEach(item => {
            ca_list.push(item);
        });
    });
    return ca_list;
}

const ca_list = generateCaList();

var ca_list_open = ca_list;
var currentViewMode = 'sections';

function createContentSections() {
    const contentContainer = document.getElementById('content-sections');
    if (!contentContainer) return; 
    
    contentContainer.innerHTML = '';
    
    ca_data.forEach((sectionData, index) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'content-section';
        sectionDiv.setAttribute('data-section-index', index);

        const headerDiv = document.createElement('div');
        headerDiv.className = 'section-header';
        headerDiv.innerHTML = `
            <h3 class="section-title">${sectionData.section}</h3>
            <span class="dropdown-arrow">â–¼</span>
        `;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'section-content';

        sectionData.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'subsection-item';

            const practiceLink = item.question_url ? 
                `<a href="${item.question_url}" target="_blank" class="subsection-link">${item.question_name}</a>` : '';
            
            const markSchemeLink = item.answer_url ? 
                `<a href="${item.answer_url}" target="_blank" class="subsection-link">${item.answer_name}</a>` : '';

            itemDiv.innerHTML = `
                <span class="subsection-name">${item.num}</span>
                <div class="subsection-links">
                    ${practiceLink}
                    ${markSchemeLink}
                </div>
            `;

            contentDiv.appendChild(itemDiv);
        });

        headerDiv.addEventListener('click', () => {
            toggleSection(headerDiv, contentDiv);
        });

        sectionDiv.appendChild(headerDiv);
        sectionDiv.appendChild(contentDiv);
        contentContainer.appendChild(sectionDiv);
    });
}

function toggleSection(header, content) {
    const isExpanded = content.classList.contains('expanded');
    
    if (isExpanded) {
        content.classList.remove('expanded');
        header.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        header.classList.add('expanded');
    }
}

function expandAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.add('expanded'));
    contents.forEach(content => content.classList.add('expanded'));
}

function collapseAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.remove('expanded'));
    contents.forEach(content => content.classList.remove('expanded'));
}

function showSectionsView() {
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    
    if (table) table.classList.add('hidden');
    if (sectionsContainer) {
        sectionsContainer.style.display = 'block';
        currentViewMode = 'sections';
    }
}

function renderTableOpen(ca_list_open) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return; 
    
    tbody.innerHTML = "";
    currentViewMode = 'table';
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    ca_list_open.forEach(ca => {
        const row = document.createElement("tr");

        const name_but_cell = document.createElement("td");
        const name = document.createElement('a');
        name.textContent = ca.num; 
        name_but_cell.appendChild(name);
        row.appendChild(name_but_cell);

        const question_but_cell = document.createElement("td");
        const question = document.createElement('a');
        question.href = ca.question_url;
        question.textContent = ca.question_name;
        question.target = "_blank"; 
        question_but_cell.appendChild(question);
        row.appendChild(question_but_cell);

        const answer_but_cell = document.createElement("td");
        const answer = document.createElement('a');
        answer.href = ca.answer_url;
        answer.textContent = ca.answer_name;
        answer.target = "_blank"; 
        answer_but_cell.appendChild(answer);
        row.appendChild(answer_but_cell);

        row.addEventListener("click", function() {
            if (ca.num === "Content Area 1") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 1") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 2") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 2") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 3") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 3") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 4") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 4") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 5") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 5") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 6") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 6") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 7") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 7") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 8") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 8") || item.num.includes("Content Area")));
            }
        });

        tbody.appendChild(row);
    });
}

function renderTable(data) {
    const table = document.getElementById('task-table');
    const tbody = table ? table.querySelector('tbody') : null;
    if (!tbody) return;
    
    tbody.innerHTML = '';
    currentViewMode = 'table';

    const sectionsContainer = document.getElementById('content-sections');
    table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    data.forEach(item => {
        const row = document.createElement('tr');
        
        const practiceCell = document.createElement('td');
        if (item.question_url) {
            practiceCell.innerHTML = `<a href="${item.question_url}" target="_blank">${item.question_name}</a>`;
        }

        const markSchemeCell = document.createElement('td');
        if (item.answer_url) {
            markSchemeCell.innerHTML = `<a href="${item.answer_url}" target="_blank">${item.answer_name}</a>`;
        }

        row.innerHTML = `<td>${item.num}</td>`;
        row.appendChild(practiceCell);
        row.appendChild(markSchemeCell);
        
        tbody.appendChild(row);
    });
}

var ca_list_closed = [
    {num: "Content Area 1"},
    {num: "Content Area 2"},
    {num: "Content Area 3"},
    {num: "Content Area 4"},
    {num: "Content Area 5"},
    {num: "Content Area 6"},
    {num: "Content Area 7"},
    {num: "Content Area 8"}
];

function renderTableClosed(ca_list_closed) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    currentViewMode = 'table';

    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';
    
    ca_list_closed.forEach(ca => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${ca.num}</td><td></td><td></td>`;
        row.addEventListener("click", function() {
            if (ca.num === "Content Area 1") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 1") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 2") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 2") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 3") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 3") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 4") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 4") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 5") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 5") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 6") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 6") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 7") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 7") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 8") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 8") || item.num.includes("Content Area")));
            }
        });
        tbody.appendChild(row);
    });
}

function filterContent(searchTerm) {
    const term = searchTerm.toLowerCase();
    
    if (term === '') {
        if (document.getElementById('content-sections')) {
            showSectionsView();
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.style.display = 'block');
        } else {
            renderTableClosed(ca_list_closed);
        }
        return;
    }

    const filtered = ca_list.filter(item =>
        item.num.toLowerCase().includes(term)
    );

    if (filtered.length > 0) {
        renderTable(filtered);
    } else {
        const table = document.getElementById('task-table');
        if (table) {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #888;">No results found</td></tr>';
            table.classList.remove('hidden');
            const sectionsContainer = document.getElementById('content-sections');
            if (sectionsContainer) sectionsContainer.style.display = 'none';
        }
    }
}

function highlightSearchTerm(text, term) {
    if (!term) return text;
    
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function getSectionByIndex(index) {
    return ca_data[index] || null;
}

function getAllItems() {
    return ca_list;
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded'); 
    console.log('ca_data:', ca_data); 
    
    const sectionsContainer = document.getElementById('content-sections');
    const table = document.getElementById('task-table');
    
    if (sectionsContainer) {
        console.log('Creating content sections');
        createContentSections();
        currentViewMode = 'sections';
    } else if (table) {
        console.log('Rendering table closed');
        renderTableClosed(ca_list_closed);
        currentViewMode = 'table';
    }
    
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filterContent(e.target.value);
        });
        
        searchInput.focus();
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchInput) {
            searchInput.value = '';
            filterContent('');
        }
    });
});