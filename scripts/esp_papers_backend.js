const esp_data = [
    {
        section: "Autumn 2024",
        items: [
            {num: "A24 Examiner Reference", task_url: "https://drive.google.com/file/d/1vv1SealeUGkc4P48w-wu7LdUYqMIaB8B/view"},
            {num: "A24 Task 1", task_url: "https://drive.google.com/file/d/1_FODoMK9o49ZbkpYDikK7xommnZsdewG/view"},
            {num: "A24 Task 2", task_url: "https://drive.google.com/file/d/1ODBh1_4eJj1vz1EZJbKj0DYTA1oyOpxp/view"},
            {num: "A24 Task 3", task_url: "https://drive.google.com/file/d/1U_DhSbOUVR4aetGgHyvgVL4w6ZYhwIVq/view"},
            {num: "A24 Task 4a", task_url: "https://drive.google.com/file/d/1h3onVJrEq6lhNwzkvT6qFd8WfWPtK-lQ/view"},
            {num: "A24 Task 4b", task_url: "https://drive.google.com/file/d/1j6TSejCA9DbOwKu9cJGMy12wROcYltYT/view"}
        ]
    },
    {
        section: "Summer 2024",
        items: [
            {num: "S24 Examiner Reference", task_url: "https://drive.google.com/file/d/1VYkSb3lme7TwEHqZicC0UEPZS7-6e0_T/view"},
            {num: "S24 Task 1", task_url: "https://drive.google.com/file/d/1TrXelp96UdobUBxBpYS1kB6-I6r0k7si/view"},
            {num: "S24 Task 2", task_url: "https://drive.google.com/file/d/1nQWLrfl-W0tNmwLJWqOTgChDO0nhzUWi/view"},
            {num: "S24 Task 3", task_url: "https://drive.google.com/file/d/1OuC6M3MgNW8o6XHxj5T1OZkWKfWv-7fN/view"},
            {num: "S24 Task 4a", task_url: "https://drive.google.com/file/d/158wa3q5f_BsqL_-TvcN-7AAaWnwrGHDt/view"},
            {num: "S24 Task 4b", task_url: "https://drive.google.com/file/d/1mRU9luyfYKgRaWXft5xASzURd4Yr5JUN/view"}
        ]
    },
    {
        section: "Autumn 2023",
        items: [
            {num: "A23 Examiner Reference", task_url: "https://drive.google.com/file/d/11HovQVNT2axk98G0PHE9zJsTkle_o8wp/view"},
            {num: "A23 Task 1", task_url: "https://drive.google.com/file/d/1vcMa4vdbkFNexHBUGQ7sSi2y8lOVufQK/view"},
            {num: "A23 Task 2", task_url: "https://drive.google.com/file/d/1-0KnQDfHf0hmZIvJQtC_4QezA5R-BL9G/view"},
            {num: "A23 Task 3", task_url: "https://drive.google.com/file/d/1juu74xYsWM6fXiV2aR67ABg9oasV0N3d/view"},
            {num: "A23 Task 4a", task_url: "https://drive.google.com/file/d/12fZhwbAiaBStC3gRiRgIO-5wh-LCUKGu/view"},
            {num: "A23 Task 4b", task_url: "https://drive.google.com/file/d/1NgRhWTb941YmD7iPaRCm_e_HkAZPNwrg/view"}
        ]
    },
    {
        section: "Summer 2023",
        items: [
            {num: "S23 Examiner Reference", task_url: "https://drive.google.com/file/d/16rjVB1Z_KEZJMPcU1u3mwj3Oa2aVPAsO/view"},
            {num: "S23 Task 1", task_url: "https://drive.google.com/file/d/1sjK91_LtTq_0sK3e0U0LyiHL5R-EMfBX/view"},
            {num: "S23 Task 2", task_url: "https://drive.google.com/file/d/1DChyvSjxgbgs6wXqdnBWzMDpOnAtQ3lS/view"},
            {num: "S23 Task 3", task_url: "https://drive.google.com/file/d/1wM_DDABUEvdUzDpQEpFmH_oWWMvmF-VX/view"},
            {num: "S23 Task 4a", task_url: "https://drive.google.com/file/d/1C8N3whH5RqAcKin_3TuKzKbo5yo3oWyT/view"},
            {num: "S23 Task 4b", task_url: "https://drive.google.com/file/d/11xmrIwtbf4iyw-QBXmfJD-GIEnwF9RTt/view"}
        ]
    },
    {
        section: "Autumn 2022",
        items: [
            {num: "A22 Examiner Reference", task_url: "https://drive.google.com/file/d/1XEgGUCBgP-lHcIdQY9XrbU8vF_Qkp4Ca/view"},
            {num: "A22 Task 1", task_url: "https://drive.google.com/file/d/1Z8j8ZVEp83RzPfajFGvjqDBXHFkHbWyE/view"},
            {num: "A22 Task 2", task_url: "https://drive.google.com/file/d/1e1Qh_2K9Of233ITdvbsHnooO5kNv3sk7/view"},
            {num: "A22 Task 3", task_url: "https://drive.google.com/file/d/19NOKMNtpE_LnY79e0uQT1PV9lit9ocGf/view"},
            {num: "A22 Task 4a", task_url: "https://drive.google.com/file/d/1D6tWxkOM6ITW3WfYQrkpKZY8zb4-Oj50/view"},
            {num: "A22 Task 4b", task_url: "https://drive.google.com/file/d/1gpDyRA9TQA7-UcqMRRSTjuu_amC8rvDu/view"}
        ]
    },
    {
        section: "Summer 2022",
        items: [
            {num: "S22 Examiner Reference", task_url: "https://drive.google.com/file/d/1KeUfDBlAINoAyY936JQQT-sfPKuIzpME/view"},
            {num: "S22 Task 1", task_url: "https://drive.google.com/file/d/1En-6B6XoRATkrXjN3baJRwUuA3rS0HZ6/view"},
            {num: "S22 Task 2", task_url: "https://drive.google.com/file/d/1bV98YOru9fZge-1vZaqbfn4ytsTEP_3d/view"},
            {num: "S22 Task 3", task_url: "https://drive.google.com/file/d/1HyzXgJHMH7y30IYkLDBoNUaX6m9v_Zu7/view"},
            {num: "S22 Task 4a", task_url: "https://drive.google.com/file/d/1IgX2kKGjOfFHR59nJ-YU8YzqQJVQPKC_/view"},
            {num: "S22 Task 4b", task_url: "https://drive.google.com/file/d/1ZTn5DDxDcsgNnQm1W4nu4Xr0xrouUmYa/view"}
        ]
    },
    {
        section: "Autumn 2021",
        items: [
            {num: "A21 Examiner Reference", task_url: "https://drive.google.com/file/d/1yXRlkG6yAvTrJ8K8c777tz037XysIACW/view"},
            {num: "A21 Task 1", task_url: "https://drive.google.com/file/d/1DtMrCzhbGiK7dmi3ytn0PfWUc49UAOWW/view"},
            {num: "A21 Task 2", task_url: "https://drive.google.com/file/d/1PvrNhj-sKfEfxO2I-mYBuhiK8ZxXEkrg/view"},
            {num: "A21 Task 3", task_url: "https://drive.google.com/file/d/1RpPGmoASHhed5X_fZ5d0jsFLvR2AucIA/view"},
            {num: "A21 Task 4a", task_url: "https://drive.google.com/file/d/1j74h3oOZ-wo4UB6go8S4f2RoD9fU79nc/view"},
            {num: "A21 Task 4b", task_url: "https://drive.google.com/file/d/1zRwyc-O8SQ6UfQGDD9orF4jwXxFxQYcf/view"}
        ]
    }
];



function generateEspList() {
    const esp_list = [];
    esp_data.forEach((section, index) => {
        esp_list.push({num: `Content Area ${index + 1}`, task_url: ""});
        section.items.forEach(item => {
            esp_list.push(item);
        });
    });
    return esp_list;
}

const esp_list = generateEspList();

var esp_list_open = esp_list;
var currentViewMode = 'sections';

function createContentSections() {
    const contentContainer = document.getElementById('content-sections');
    if (!contentContainer) return; 
    
    contentContainer.innerHTML = '';
    
    esp_data.forEach((sectionData, index) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'content-section';
        sectionDiv.setAttribute('data-section-index', index);

        const headerDiv = document.createElement('div');
        headerDiv.className = 'section-header';
        headerDiv.innerHTML = `
            <h3 class="section-title">${sectionData.section}</h3>
            <span class="dropdown-arrow">â–¼</span>`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'section-content';

        sectionData.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'subsection-item';


            itemDiv.innerHTML = `<span class="subsection-name">${item.num}</span>`;

            if (item.task_url) {
                itemDiv.addEventListener('click', () => {
                window.open(item.task_url, '_blank');
                });
            }

            contentDiv.appendChild(itemDiv);
        });

        headerDiv.addEventListener('click', () => {
            toggleSection(headerDiv, contentDiv);
        });

        sectionDiv.appendChild(headerDiv);
        sectionDiv.appendChild(contentDiv);
        contentContainer.appendChild(sectionDiv);
    });
}

function toggleSection(header, content) {
    const isExpanded = content.classList.contains('expanded');
    
    if (isExpanded) {
        content.classList.remove('expanded');
        header.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        header.classList.add('expanded');
    }
}

function expandAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.add('expanded'));
    contents.forEach(content => content.classList.add('expanded'));
}

function collapseAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.remove('expanded'));
    contents.forEach(content => content.classList.remove('expanded'));
}

function showSectionsView() {
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    
    if (table) table.classList.add('hidden');
    if (sectionsContainer) {
        sectionsContainer.style.display = 'block';
        currentViewMode = 'sections';
    }
}

function renderTableOpen(esp_list_open) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return; 
    
    tbody.innerHTML = "";
    currentViewMode = 'table';
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    esp_list_open.forEach(esp =>{

        if (esp.num.includes('Task') || ('Examinar')) {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${esp.num}</td>`;
            row.addEventListener("click", function() {
                window.open(`${esp.task_url}`);
            });
        }

        tbody.appendChild(row);
    });
}

function renderTable(data) {
    const table = document.getElementById('task-table');
    const tbody = table ? table.querySelector('tbody') : null;
    if (!tbody) return;
    
    tbody.innerHTML = '';
    currentViewMode = 'table';

    const sectionsContainer = document.getElementById('content-sections');
    table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    data.forEach(item => {
        const row = document.createElement('tr');

        // Add the click listener to the entire row here
        if (item.task_url) {
            row.addEventListener('click', () => {
                window.open(item.task_url, '_blank');
            });
        }
        
        // This is your numCell equivalent, which you already have.
        const numCell = document.createElement('td');
        numCell.textContent = item.num;
        row.appendChild(numCell);


        row.innerHTML = `<td>${item.num}</td>`;
        //row.appendChild(practiceCell);
        
        tbody.appendChild(row);
    });
}

var esp_list_closed = [
    {num: "Autumn 2024"},
    {num: "Summer 2024"},
    {num: "Autumn 2023"},
    {num: "Summer 2023"},
    {num: "Autumn 2022"},
    {num: "Summer 2022"},
    {num: "Autumn 2021"}
];

function renderTableClosed(esp_list_closed) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    currentViewMode = 'table';

    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';
    
    esp_list_closed.forEach(esp => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${esp.num}</td><td></td><td></td>`;
        row.addEventListener("click", function() {
            if (esp.num === "Autumn 2024") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("A24") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Summer 2024") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("S24") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Autumn 2023") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("A23") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Summer 2023") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("S23") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Autumn 2022") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("A22") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Summer 2022") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("S22") || item.num.includes("Autumn") || item.num.includes("Summer")));
            } else if (esp.num === "Autumn 2021") {
                renderTableOpen(esp_list_open.filter(item => item.num.includes("A21") || item.num.includes("Autumn") || item.num.includes("Summer")));
            }
        } )
        tbody.appendChild(row);
    });
}

function filterContent(searchTerm) {
    const term = searchTerm.toLowerCase();
    
    if (term === '') {
        if (document.getElementById('content-sections')) {
            showSectionsView();
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.style.display = 'block');
        } else {
            renderTableClosed(esp_list_closed);
        }
        return;
    }

    const filtered = esp_list.filter(item =>
        item.num.toLowerCase().includes(term)
    );

    if (filtered.length > 0) {
        renderTable(filtered);
    } else {
        const table = document.getElementById('task-table');
        if (table) {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #888;">No results found</td></tr>';
            table.classList.remove('hidden');
            const sectionsContainer = document.getElementById('content-sections');
            if (sectionsContainer) sectionsContainer.style.display = 'none';
        }
    }
}

function highlightSearchTerm(text, term) {
    if (!term) return text;
    
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function getSectionByIndex(index) {
    return esp_data[index] || null;
}

function getAllItems() {
    return esp_list;
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded'); 
    console.log('esp_data:', esp_data); 
    
    const sectionsContainer = document.getElementById('content-sections');
    const table = document.getElementById('task-table');
    
    if (sectionsContainer) {
        console.log('Creating content sections');
        createContentSections();
        currentViewMode = 'sections';
    } else if (table) {
        console.log('Rendering table closed');
        renderTableClosed(esp_list_closed);
        currentViewMode = 'table';
    }
    
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filterContent(e.target.value);
        });
        
        searchInput.focus();
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchInput) {
            searchInput.value = '';
            filterContent('');
        }
    });
});
