const ca_data = [
    {
        section: "1. Problem Solving & Algorithms",
        items: [
            {num: "CA 1: Problem Sovling", url: "https://drive.google.com/file/d/10CHzLHadGqralTj7eQJ_NMBPVyDo0KC1/view?usp=classroom_web&authuser=0"},
            {num: "CA 1.1: Problem Sovling", url: "https://drive.google.com/file/d/1eswXepjzPg1NENspuwUXSPB5srF8blHD/view?usp=drive_link"},
            {num: "CA 1.2: Algorithms", url: "https://drive.google.com/file/d/1Uf9cUyqGhRSBqNkQ-NwGoITZEzeU1hTU/view?usp=drive_link"}
        ]
    },
    {
        section: "2. Introduction to Programming",
        items: [
            {num: "CA 2: Introduction to Programming", url: "https://drive.google.com/file/d/1ATYC8KIA911ln3K75UpQUNUpHXML9s8O/view?usp=classroom_web&authuser=0"},
            {num: "CA 2.1: Program Data", url: "https://drive.google.com/file/d/1T3k1Fy5X8UVq0Ya-byoefPSb4cRlKbLD/view?usp=drive_link"},
            {num: "CA 2.2: Operators", url: "https://drive.google.com/file/d/1_r1cohSIlsWBZ3wxhJ9rYHk-nVlvFdmk/view?usp=drive_link"},
            {num: "CA 2.3: File handling", url: "https://drive.google.com/file/d/1FCwY_qSUl2LCthOh3d3lTOx6c3BvMq-D/view?usp=drive_link"},
            {num: "CA 2.4: Program Structure", url: "https://drive.google.com/file/d/1hqn4HWgpwGDTyBY6RfSQgOCVQ9OToFlo/view?usp=drive_link"},
            {num: "CA 2.5: Built-in Functions", url: "https://drive.google.com/file/d/10CcsVQ-ENgUmI3iPtq8wZTO8KbqchJRx/view?usp=drive_link"},
            {num: "CA 2.6: Validation and Error Handling", url: "https://drive.google.com/file/d/1GWXrgAeOWlhRjfnX1OYTgEiWx_WdlGAW/view?usp=drive_link"},
            {num: "CA 2.7: Maintainable Code", url: "https://drive.google.com/file/d/10DX1p5kdMa7_UY34-zk3nVJcCd6T_0Ul/view?usp=drive_link"},
            {num: "CA 2.8: Testing", url: "https://drive.google.com/file/d/1A0PQo9JSFXfhJBvdXyzLlYP380srr6RA/view?usp=drive_link"}
        ]
    },
    {
        section: "3. Emerging Issues",
        items: [
            {num: "CA 3: Emerging Issues", url: "https://drive.google.com/file/d/1Qz0iSa7tV8_jVHTejpdp8FOLCVdrZ5YF/view?usp=classroom_web&authuser=0"},
            {num: "CA 3.1: Moral and Ethical Issues", url: "https://drive.google.com/file/d/1AEQQp27PD52L4xjL6OhyTD-yVTNWJdyt/view?usp=drive_link"},
            {num: "CA 3.2: Emerging Trends and Technologies", url: "https://drive.google.com/file/d/1nmLQgVzcRTLqCdqbvbSEvlf2Vb-fbKw2/view?usp=drive_link"}
        ]
    },
    {
        section: "4. Legislation & Regulatory Requirements",
        items: [
            {num: "CA 4: Legislation and Regulatory Requirments", url: "https://drive.google.com/file/d/1Ir5xeqrmLnAnC6nzCEg1NX7D6x9oHHiI/view?usp=classroom_web&authuser=0"},
            {num: "CA 4.1: Legislation", url: "https://drive.google.com/file/d/133dycIL6f8xWrQCFuz1L1UGEGsO_la1R/view?usp=drive_link"},
            {num: "CA 4.2: Guidelines and codes of conduct", url: "https://drive.google.com/file/d/1ZKRQqBgymVezzKGi8tHWwZjjsVWQrUEK/view?usp=drive_link"}
        ]
    },
    {
        section: "5. Business Context",
        items: [
            {num: "CA 5: Business Context", url: "https://drive.google.com/file/d/1fAS6NGq0klBQmtqf69-GNweGiWGH1FCM/view?usp=classroom_web&authuser=0"},
            {num: "CA 5.1: Business Environment", url: "https://drive.google.com/file/d/19EUooZiaD7cELaaUNI0aTeO8q1RND1F-/view?usp=drive_link"},
            {num: "CA 5.2: Digital Value To Business", url: "https://drive.google.com/file/d/10PJ1xmyKft1LerZzob7SzFMRA1f9cyMe/view?usp=drive_link"},
            {num: "CA 5.3: Technical Change Management", url: "https://drive.google.com/file/d/1-LO5YIuGObzljJSx5UCUrIsiooaRQ1w9/view?usp=drive_link"},
            {num: "CA 5.4: Risks in a Business Context", url: "https://drive.google.com/file/d/1bfn9X_jx6WdoJy7vVve4pJiqEcrtFM6X/view?usp=drive_link"}
        ]
    },
    {
        section: "6. Data",
        items: [
            {num: "CA 6: Data", url: "https://drive.google.com/file/d/15okiwBpYWQVad5r2lBX0MBAiA18xfIZx/view?usp=classroom_web&authuser=0"},
            {num: "CA 6.1: Data and information in organisations", url: "https://drive.google.com/file/d/1MgbSJ68UesZjJdpDfMIJZEqQvWNI8B_M/view?usp=drive_link"},
            {num: "CA 6.1: Data formats", url: "https://drive.google.com/file/d/1a109s3CRjnT5m8QFI5dpohl3ArTD0pTM/view?usp=drive_link"},
            {num: "CA 6.1: Data Systems", url: "https://drive.google.com/file/d/1A9ZCLJG8_jRPdr8-Xrc1Ua5iHQpJlKGl/view?usp=drive_link"},
            {num: "CA 6.1: Data Management", url: "https://drive.google.com/file/d/1BQ76j0CZ5tJIySKRochasL0JhHuOMBj5/view?usp=drive_link"}
        ]
    },
    {
        section: "7. Digital Environments",
        items: [
            {num: "CA 7: Digital Environments", url: "https://drive.google.com/file/d/1IM4pvacMUmkSFZlK8zK4RUcOaOMmhqxL/view?usp=classroom_web&authuser=0"},
            {num: "CA 7.1: Physical Environments", url: "https://drive.google.com/file/d/1eQM7lAKZdC6otwgjypI0dyFnZ4-xFO_O/view?usp=drive_link"},
            {num: "CA 7.1: Networks", url: "https://drive.google.com/file/d/1lDmORiTpkWdvm2dZhajU4v9wCX7y-bQO/view?usp=drive_link"},
            {num: "CA 7.1: Virtual Environments", url: "https://drive.google.com/file/d/1gGZzyWLdGJ_tT9cIF6Ab_jC0ShyNbam7/view?usp=drive_link"},
            {num: "CA 7.1: Cloud Environments", url: "https://drive.google.com/file/d/1b70r3GRLJBX8yUYZPmqxw-dp2isHIzpP/view?usp=drive_link"},
            {num: "CA 7.1: Resilience of Environment", url: "https://drive.google.com/file/d/1HXGjYiNCAJh0EwjjW21G8g9e9__WfN_2/view?usp=drive_link"}
        ]
    },
    {
        section: "8. Security",
        items: [
            {num: "CA 8: Security", url: "https://drive.google.com/file/d/1UqSiXxxZ-vHgg83S2jNP4D3ZAZfZHwYY/view?usp=classroom_web&authuser=0"},
            {num: "CA 8.1: Security Risks", url: "https://drive.google.com/file/d/1hKoK_CHMUIQcz5OXaXdWTIsb-3p0Fd66/view?usp=drive_link"},
            {num: "CA 8.1: Threat mitigation", url: "https://drive.google.com/file/d/1cJIBIggoKIei52riP32-5m7QQKNCF1i8/view?usp=drive_link"}
        ]
    }
];



function generateCaList() {
    const ca_list = [];
    ca_data.forEach((section, index) => {
        ca_list.push({num: `Content Area ${index + 1}`, url: ""});
        section.items.forEach(item => {
            ca_list.push(item);
        });
    });
    return ca_list;
}

const ca_list = generateCaList();

var ca_list_open = ca_list;
var currentViewMode = 'sections';

function createContentSections() {
    const contentContainer = document.getElementById('content-sections');
    if (!contentContainer) return; 
    
    contentContainer.innerHTML = '';
    
    ca_data.forEach((sectionData, index) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'content-section';
        sectionDiv.setAttribute('data-section-index', index);

        const headerDiv = document.createElement('div');
        headerDiv.className = 'section-header';
        headerDiv.innerHTML = `
            <h3 class="section-title">${sectionData.section}</h3>
            <span class="dropdown-arrow">â–¼</span>`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'section-content';

        sectionData.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'subsection-item';


            itemDiv.innerHTML = `<span class="subsection-name">${item.num}</span>`;

            if (item.url) {
                itemDiv.addEventListener('click', () => {
                window.open(item.url, '_blank');
                });
            }

            contentDiv.appendChild(itemDiv);
        });

        headerDiv.addEventListener('click', () => {
            toggleSection(headerDiv, contentDiv);
        });

        sectionDiv.appendChild(headerDiv);
        sectionDiv.appendChild(contentDiv);
        contentContainer.appendChild(sectionDiv);
    });
}

function toggleSection(header, content) {
    const isExpanded = content.classList.contains('expanded');
    
    if (isExpanded) {
        content.classList.remove('expanded');
        header.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        header.classList.add('expanded');
    }
}

function expandAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.add('expanded'));
    contents.forEach(content => content.classList.add('expanded'));
}

function collapseAllSections() {
    const headers = document.querySelectorAll('.section-header');
    const contents = document.querySelectorAll('.section-content');
    
    headers.forEach(header => header.classList.remove('expanded'));
    contents.forEach(content => content.classList.remove('expanded'));
}

function showSectionsView() {
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    
    if (table) table.classList.add('hidden');
    if (sectionsContainer) {
        sectionsContainer.style.display = 'block';
        currentViewMode = 'sections';
    }
}

function renderTableOpen(ca_list_open) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return; 
    
    tbody.innerHTML = "";
    currentViewMode = 'table';
    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    ca_list_open.forEach(ca =>{

        if (ca.num.includes('CA')) {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${ca.num}</td>`;
            row.addEventListener("click", function() {
                window.open(`${ca.url}`);
            });
        }

        tbody.appendChild(row);
    });
}

function renderTable(data) {
    const table = document.getElementById('task-table');
    const tbody = table ? table.querySelector('tbody') : null;
    if (!tbody) return;
    
    tbody.innerHTML = '';
    currentViewMode = 'table';

    const sectionsContainer = document.getElementById('content-sections');
    table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';

    data.forEach(item => {
        const row = document.createElement('tr');

        // Add the click listener to the entire row here
        if (item.url) {
            row.addEventListener('click', () => {
                window.open(item.url, '_blank');
            });
        }
        
        // This is your numCell equivalent, which you already have.
        const numCell = document.createElement('td');
        numCell.textContent = item.num;
        row.appendChild(numCell);


        row.innerHTML = `<td>${item.num}</td>`;
        //row.appendChild(practiceCell);
        
        tbody.appendChild(row);
    });
}

var ca_list_closed = [
    {num: "Content Area 1"},
    {num: "Content Area 2"},
    {num: "Content Area 3"},
    {num: "Content Area 4"},
    {num: "Content Area 5"},
    {num: "Content Area 6"},
    {num: "Content Area 7"},
    {num: "Content Area 8"}
];

function renderTableClosed(ca_list_closed) {
    const tbody = document.querySelector("#task-table tbody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    currentViewMode = 'table';

    const table = document.getElementById('task-table');
    const sectionsContainer = document.getElementById('content-sections');
    if (table) table.classList.remove('hidden');
    if (sectionsContainer) sectionsContainer.style.display = 'none';
    
    ca_list_closed.forEach(ca => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${ca.num}</td><td></td><td></td>`;
        row.addEventListener("click", function() {
            if (ca.num === "Content Area 1") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 1") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 2") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 2") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 3") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 3") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 4") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 4") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 5") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 5") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 6") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 6") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 7") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 7") || item.num.includes("Content Area")));
            } else if (ca.num === "Content Area 8") {
                renderTableOpen(ca_list.filter(item => item.num.includes("CA 8") || item.num.includes("Content Area")));
            }
        });
        tbody.appendChild(row);
    });
}

function filterContent(searchTerm) {
    const term = searchTerm.toLowerCase();
    
    if (term === '') {
        if (document.getElementById('content-sections')) {
            showSectionsView();
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.style.display = 'block');
        } else {
            renderTableClosed(ca_list_closed);
        }
        return;
    }

    const filtered = ca_list.filter(item =>
        item.num.toLowerCase().includes(term)
    );

    if (filtered.length > 0) {
        renderTable(filtered);
    } else {
        const table = document.getElementById('task-table');
        if (table) {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #888;">No results found</td></tr>';
            table.classList.remove('hidden');
            const sectionsContainer = document.getElementById('content-sections');
            if (sectionsContainer) sectionsContainer.style.display = 'none';
        }
    }
}

function highlightSearchTerm(text, term) {
    if (!term) return text;
    
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function getSectionByIndex(index) {
    return ca_data[index] || null;
}

function getAllItems() {
    return ca_list;
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded'); 
    console.log('ca_data:', ca_data); 
    
    const sectionsContainer = document.getElementById('content-sections');
    const table = document.getElementById('task-table');
    
    if (sectionsContainer) {
        console.log('Creating content sections');
        createContentSections();
        currentViewMode = 'sections';
    } else if (table) {
        console.log('Rendering table closed');
        renderTableClosed(ca_list_closed);
        currentViewMode = 'table';
    }
    
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            filterContent(e.target.value);
        });
        
        searchInput.focus();
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchInput) {
            searchInput.value = '';
            filterContent('');
        }
    });
});